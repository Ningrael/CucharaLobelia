<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Misiones – @cucharalobelia</title>
  <!-- React 18 + Babel (sin build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{margin:0;height:100%;background:#3b2b20}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useRef, useState, useEffect, useMemo } = React;

    // ==== I18N (ES/EN) ====
    const I18N = {
      es: {
        brand: "@cucharalobelia Misiones",
        random: "Elegir Random",
        rounds: "Rondas",
        generate: "Generar",
        back: "Volver",
        close: "Cerrar",
        pdf_missing: "Función en construcción o PDF no encontrado",
        stepper_dec: "Quitar ronda",
        stepper_inc: "Agregar ronda",
        rounds_group: "Rondas y generar",
        lang_es_aria: "Cambiar idioma a Español",
        lang_en_aria: "Cambiar idioma a Inglés",
      },
      en: {
        brand: "@cucharalobelia Missions",
        random: "Pick Random",
        rounds: "Rounds",
        generate: "Generate",
        back: "Back",
        close: "Close",
        pdf_missing: "Feature under construction or PDF not found",
        stepper_dec: "Decrease rounds",
        stepper_inc: "Increase rounds",
        rounds_group: "Rounds and generate",
        lang_es_aria: "Switch language to Spanish",
        lang_en_aria: "Switch language to English",
      }
    };

    const getSavedLang = () => {
      const v = localStorage.getItem('lobelia_lang');
      return v === 'en' ? 'en' : 'es';
    };

    const applyI18n = (lang) => {
      const dict = I18N[lang] || I18N.es;
      document.documentElement.lang = lang;
      document.title = lang === 'en' ? 'Missions – @cucharalobelia' : 'Misiones – @cucharalobelia';
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (key && dict[key] != null) el.textContent = dict[key];
      });
      const decBtn = document.querySelector('[data-i18n-aria-dec]');
      if (decBtn) decBtn.setAttribute('aria-label', dict.stepper_dec);
      const incBtn = document.querySelector('[data-i18n-aria-inc]');
      if (incBtn) incBtn.setAttribute('aria-label', dict.stepper_inc);
      const roundsGroup = document.querySelector('[data-i18n-aria-roundsgroup]');
      if (roundsGroup) roundsGroup.setAttribute('aria-label', dict.rounds_group);
      const esBtn = document.querySelector('[data-i18n-aria-lang-es]');
      if (esBtn) esBtn.setAttribute('aria-label', dict.lang_es_aria);
      const enBtn = document.querySelector('[data-i18n-aria-lang-en]');
      if (enBtn) enBtn.setAttribute('aria-label', dict.lang_en_aria);
    };

    const saveLang = (lang) => { localStorage.setItem('lobelia_lang', lang); applyI18n(lang); };

    const POOLS = [
      { items: ["Domination", "Capture & Control", "Breakthrough", "Stake a Claim"]},
      { items: ["To the Death!", "Lords of Battle", "Assassination", "Contest of Champions"]},
      { items: ["Hold Ground", "Heirloom of Ages Past", "Sites of Power", "Command the Battlefield"]},
      { items: ["Destroy the Supplies", "Retrieval", "Seize the Prizes", "Treasure Hoard"]},
      { items: ["Reconnoitre", "Storm the Camp", "Divide & Conquer", "Escort the Wounded"]},
      { items: ["Fog of War", "Clash by Moonlight", "Lead from the Front", "Convergence"]},
    ];

    function App(){
      const [selected, setSelected] = useState("");
      const [lang, setLang] = useState(getSavedLang());
      const allMissions = useMemo(() => POOLS.flatMap(p => p.items || []), []);
      const [rounds, setRounds] = useState("3");
      const screenRef = useRef(null);
      const bannerRef = useRef(null);
      const controlsRef = useRef(null);
      const footerRef = useRef(null);
      const gridRef = useRef(null);

      const [badges, setBadges] = useState({});

      // --- visor PDF en modal ---
      const [pdfViewerSrc, setPdfViewerSrc] = useState("");
      const [showPdf, setShowPdf] = useState(false);

      const recalcSizes = () => {
        const screen = screenRef.current; if (!screen) return;
        const bannerH   = (bannerRef.current   && bannerRef.current.getBoundingClientRect().height) || 0;
        const controlsH = (controlsRef.current && controlsRef.current.getBoundingClientRect().height) || 0;
        const footerH   = (footerRef.current   && footerRef.current.getBoundingClientRect().height) || 0;

        let availH = screen.clientHeight - bannerH - controlsH - footerH - 8;
        let availW = screen.clientWidth - 8*2;

        const gap = 6;
        const cols = 2, rows = 3;
        const sizeByH = Math.floor((availH - gap * (rows + 1)) / rows);
        const sizeByW = Math.floor((availW - gap * (cols + 1)) / cols);
        const tile = Math.max(0, Math.min(sizeByH, sizeByW));

        const pad = 6;
        const innerW = tile - pad*2;
        const innerH = tile - pad*2;
        const btnGap = 6;
        const subCols = 2, subRows = 2;
        const btnW = Math.max(0, Math.floor((innerW - btnGap * (subCols - 1)) / subCols));
        const btnH = Math.max(0, Math.floor((innerH - btnGap * (subRows - 1)) / subRows));

        const rootStyle = gridRef.current && gridRef.current.style; if (!rootStyle) return;
        rootStyle.setProperty("--tile", `${tile}px`);
        rootStyle.setProperty("--btnW", `${btnW}px`);
        rootStyle.setProperty("--btnH", `${btnH}px`);
        rootStyle.setProperty("--gap", `${gap}px`);
      };

      useEffect(()=>{
        applyI18n(lang);
        recalcSizes();
        const onR = () => recalcSizes();
        window.addEventListener('resize', onR);
        return ()=> window.removeEventListener('resize', onR);
      },[]);

      useEffect(()=>{ saveLang(lang); }, [lang]);

      const pickRandom = () => {
        if (!allMissions.length) return;
        setBadges({});
        const name = allMissions[Math.floor(Math.random()*allMissions.length)];
        setSelected(name);
      };

      const clampRounds = (v) => {
        let n = parseInt(v||"3",10); if(Number.isNaN(n)) n=3; n = Math.max(1, Math.min(6, n)); return String(n);
      };

      const generateRounds = () => {
        const n = parseInt(clampRounds(rounds),10);
        const idxs = Array.from({length: POOLS.length}, (_,i)=>i);
        for(let i=idxs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [idxs[i], idxs[j]] = [idxs[j], idxs[i]]; }
        const chosen = idxs.slice(0, n);
        const b = {};
        let last = null;
        chosen.forEach((pi, k)=>{
          const pool = POOLS[pi];
          const items = pool.items||[]; if (!items.length) return;
          const m = items[Math.floor(Math.random()*items.length)];
          b[m] = k+1;
          last = m;
        });
        setBadges(b);
        if (last) setSelected(last);
      };

      const dec = () => { let n = parseInt(rounds||"3",10); if(Number.isNaN(n)) n=3; if(n>1) setRounds(String(n-1)); };
      const inc = () => { let n = parseInt(rounds||"3",10); if(Number.isNaN(n)) n=3; if(n<6) setRounds(String(n+1)); };

      // --- abrir mision en visor PDF sin descargar ---
      const handleMissionClick = async (name) => {
        const baseName = (name || '').toUpperCase() + '.pdf';
        const base = new URL('.', window.location.href); // carpeta actual (/misiones/)
        const candidates = [
          new URL(baseName, base).href, // dejar al navegador codificar espacios
          new URL(encodeURIComponent(baseName), base).href, // variante codificada explícita
          new URL(baseName.replace(/ /g, '_'), base).href, // variante con guiones bajos
          new URL(baseName.replace(/!/g, ''), base).href, // variante sin '!'
        ];

        for (const href of candidates) {
          try {
            const res = await fetch(href, { method: 'HEAD', cache: 'no-store' });
            if (res.ok) {
              const viewer = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(href)}`;
              setPdfViewerSrc(viewer);
              setShowPdf(true);
              setSelected(name);
              return;
            }
          } catch (_) { /* intenta siguiente */ }
        }
        alert(I18N[getSavedLang()].pdf_missing);
      };

      const closePdf = () => {
        setShowPdf(false);
        setTimeout(()=> setPdfViewerSrc('about:blank'), 200);
      };

      // --- mini pruebas de sanidad en consola ("test cases" livianos) ---
      useEffect(()=>{
        try {
          console.assert(Array.isArray(POOLS) && POOLS.length === 6, 'POOLS debe tener 6 entradas');
          console.assert(POOLS.every(p=>Array.isArray(p.items)&&p.items.length===4), 'Cada pool debe tener 4 misiones');
          const varsOk = getComputedStyle(document.documentElement);
          // Ejecuta un recálculo y comprueba que tile > 0
          recalcSizes();
          const grid = gridRef.current; if (grid) {
            const tile = parseInt(grid.style.getPropertyValue('--tile')||'0',10);
            console.assert(tile>0, 'El tamaño de tile debería ser > 0');
          }
        } catch(e){ console.warn('Self-check warning:', e); }
      },[]);

      return (
        <div className="stage" style={{minHeight:"100svh",display:"flex",alignItems:"center",justifyContent:"center",background:"#3b2b20"}}>
          <style>{`
            :root{
              --cream:#EFE5CF; --cream-2:#F7EFDA;
              --ink:#221b14; --ink-soft:#574635;
              --gold:#CFA15B; --gold-2:#EAD39A; --gold-line:#B79045;
              --shadow-lg:0 14px 40px rgba(0,0,0,.40);
              --shadow-sm:0 4px 14px rgba(0,0,0,.18);
              --tile:120px; --btnW:54px; --btnH:54px; --gap:6px;
              --radius:14px; --radius-pill:9999px;
            }
            *{box-sizing:border-box}

            .phone{aspect-ratio:9/16; width:min(96vw,480px); max-height:min(98vh,940px); border-radius:22px; padding:6px; box-shadow:var(--shadow-lg); background:#3b2b20; border:1px solid rgba(0,0,0,.45); position:relative}
            .screen{position:absolute; inset:8px; border-radius:18px; overflow:hidden; display:flex; flex-direction:column; background:transparent;}
            .screen::before{content:""; position:absolute; inset:0; background:url('../Inicio.png') center/cover no-repeat; z-index:0}
            .screen > *{position:relative; z-index:1}

            .banner{padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); display:flex; align-items:center; justify-content:flex-start; position:relative}
            .brand{font-family:Georgia,serif; font-weight:900; color:var(--cream); font-size:16px; letter-spacing:.3px; text-shadow:0 1px 0 rgba(0,0,0,.35)}

            .top-right{ position:absolute; top:8px; right:8px; z-index:2; display:flex; align-items:center; gap:6px; }
            .flag-btn{ width:26px; height:18px; border:none; background-size:cover; background-position:center; border-radius:4px; cursor:pointer; box-shadow:var(--shadow-sm); }
            @media(hover:hover){ .flag-btn:hover{ filter:brightness(1.03); } }

            .controls{padding:6px 8px; display:flex; align-items:center; justify-content:space-between; gap:8px; background:rgba(0,0,0,.12); border-bottom:1px solid rgba(255,255,255,.10)}

            .btn-gold,.btn-secondary{appearance:none; border:1px solid var(--gold-line); border-radius:var(--radius-pill); color:var(--ink);
              padding:6px 12px; font-weight:800; cursor:pointer; transition:transform .06s ease, filter .18s ease, box-shadow .18s ease;
              box-shadow:var(--shadow-sm)}
            .btn-sm{padding:5px 10px}

            .btn-gold{background:linear-gradient(180deg,var(--gold-2),var(--gold));}
            .btn-secondary{background:linear-gradient(180deg, #f0e7cf, #e2d7bb); color:var(--ink)}
            .btn-gold:active,.btn-secondary:active{transform:translateY(1px) scale(.99)}
            @media(hover:hover){ .btn-gold:hover,.btn-secondary:hover{filter:brightness(1.05)} }

            .stack{display:flex; align-items:center; gap:6px}
            .rounds-group{display:flex; align-items:center; gap:8px; padding:6px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.10); border-radius:9999px}
            .rounds-label{color:#f4e9d2; font-weight:900; margin:0 4px}
            .stepper{display:flex; align-items:center; gap:6px}
            .btn-circle{width:24px;height:24px;border-radius:var(--radius-pill);display:inline-flex;align-items:center;justify-content:center;
              border:1px solid var(--gold-line); background:linear-gradient(180deg,var(--gold-2),var(--gold)); color:var(--ink); font-weight:900; box-shadow:var(--shadow-sm)}
            .rounds-input{appearance:none;-moz-appearance:textfield;width:40px;padding:4px 6px;border-radius:10px;border:1px solid rgba(255,255,255,.25);
              background:rgba(0,0,0,.28);color:var(--cream);font-weight:800;text-align:center}

            .content{flex:1; overflow:hidden}
            .pools{height:100%; padding:var(--gap) 4px}
            .pools-grid{height:100%; display:grid; grid-template-columns:repeat(2, var(--tile)); grid-template-rows:repeat(3, var(--tile)); gap:var(--gap); justify-content:center}

            .pool-card{width:var(--tile); height:var(--tile);
              /* Transparencia 25% para lucir el fondo */
              background:linear-gradient(180deg, rgba(239,229,207,.25), rgba(247,239,218,.25));
              border:1px solid rgba(0,0,0,.12); border-radius:var(--radius); padding:6px; box-shadow:var(--shadow-sm); display:flex; flex-direction:column}

            .missions{list-style:none; padding:0; margin:0; flex:1; display:grid; grid-template-columns:repeat(2, 1fr); grid-template-rows:repeat(2, 1fr); gap:6px; align-items:stretch; justify-items:stretch}
            .missions>li{min-width:0; min-height:0; position:relative}

            .item{width:100%; height:100%; border:1px solid rgba(0,0,0,.12); border-radius:12px; background:#fff8e9; display:flex; align-items:center; justify-content:center; padding:4px; text-align:center; box-shadow:inset 0 -1px 0 rgba(0,0,0,.04)}
            .item .label{font-weight:700; font-size:11px; color:var(--ink); max-width:100%; text-align:center; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
            .item:active{transform:translateY(1px)}
            /* Selección visible: pinta todo el casillero en dorado (mismo que botón) */
            .item.selected{border-color:var(--gold-line); background:linear-gradient(180deg,var(--gold-2),var(--gold)); box-shadow:0 0 0 1px var(--gold-line) inset, 0 8px 18px rgba(0,0,0,.18)}
            .item.selected .label{color:#1c1a16}

            .badge{position:absolute; right:6px; top:6px; padding:2px 6px; border-radius:999px; background:rgba(12,11,9,.85); border:1px solid rgba(234,211,154,.6); color:#f2e6c6; font-size:10px; font-weight:800}

            .footer{padding:8px; text-align:center; background:rgba(0,0,0,.15); border-top:1px solid rgba(255,255,255,.1)}
            .btn-footer{border-radius:var(--radius-pill); border:1px solid rgba(234,211,154,.5); background:rgba(12,11,9,.65); color:#f4e9d2; padding:8px 16px; font-weight:800}

            /* Modal visor PDF */
            .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:9999; }
            .modal-card{ width:min(96vw,980px); height:min(90vh,900px); background:#111; border:1px solid #3d3d3d; border-radius:16px; overflow:hidden; position:relative; box-shadow:0 20px 60px rgba(0,0,0,.5) }
            .modal-close{ position:absolute; top:8px; right:8px; z-index:2; border-radius:999px; padding:6px 10px; background:linear-gradient(180deg,var(--gold-2),var(--gold)); border:1px solid var(--gold-line); font-weight:800; cursor:pointer }
            .modal-iframe{ width:100%; height:100%; border:0; background:#222 }
          `}</style>

          <div className="phone">
            <div className="screen" ref={screenRef}>
              <div className="banner" ref={bannerRef}>
                <div className="brand" data-i18n="brand">@cucharalobelia Misiones</div>
                <div className="top-right" role="group" aria-label="Language">
                  <button className="flag-btn" onClick={()=> setLang('es')} style={{backgroundImage:"url('https://flagcdn.com/w20/es.png')"}} data-i18n-aria-lang-es aria-label="ES"></button>
                  <button className="flag-btn" onClick={()=> setLang('en')} style={{backgroundImage:"url('https://flagcdn.com/w20/gb.png')"}} data-i18n-aria-lang-en aria-label="EN"></button>
                </div>
              </div>

              <div className="controls" ref={controlsRef}>
                <button onClick={pickRandom} className="btn-gold" data-i18n="random">Elegir Random</button>

                <div className="rounds-group" role="group" data-i18n-aria-roundsgroup aria-label="Rondas y generar">
                  <span className="rounds-label" data-i18n="rounds">Rondas</span>
                  <div className="stepper">
                    <button className="btn-circle" onClick={()=>setRounds(r=>{let n=parseInt(r||"3",10); if(Number.isNaN(n)) n=3; return String(Math.max(1,n-1));})} data-i18n-aria-dec aria-label="Quitar ronda">-</button>
                    <input className="rounds-input" type="text" inputMode="numeric" value={rounds}
                      onChange={(e)=>{ const v=e.target.value.trim(); if (v===""){setRounds("");return;} if (/^[1-6]$/.test(v)){setRounds(v);} }}
                      onBlur={()=>{ if (rounds === "") setRounds("3"); }} />
                    <button className="btn-circle" onClick={()=>setRounds(r=>{let n=parseInt(r||"3",10); if(Number.isNaN(n)) n=3; return String(Math.min(6,n+1));})} data-i18n-aria-inc aria-label="Agregar ronda">+</button>
                  </div>
                  <button onClick={generateRounds} className="btn-secondary btn-sm" data-i18n="generate">Generar</button>
                </div>
              </div>

              <div className="content">
                <div className="pools">
                  <div className="pools-grid" ref={gridRef}>
                    {Array.isArray(POOLS) && POOLS.map((pool, pi)=> (
                      <section key={pi} className="pool-card">
                        <ul className="missions">
                          {(pool.items||[]).map((name)=> {
                            const isSel = selected === name;
                            const badge = badges[name];
                            return (
                              <li key={name}>
                                <button
                                  onClick={()=> handleMissionClick(name)}
                                  className={"item" + (isSel ? " selected" : "")}
                                  aria-label={name}
                                >
                                  <span className="label">{name}</span>
                                  {badge ? <span className="badge">R{badge}</span> : null}
                                </button>
                              </li>
                            );
                          })}
                        </ul>
                      </section>
                    ))}
                  </div>
                </div>
              </div>

              <div className="footer" ref={footerRef}>
                <button className="btn-footer" onClick={()=> window.location.href = "../index.html"} data-i18n="back">Volver</button>
              </div>
            </div>
          </div>

          {showPdf ? (
            <div className="modal-backdrop" role="dialog" aria-modal="true" onKeyDown={(e)=>{ if(e.key==='Escape') closePdf(); }}>
              <div className="modal-card">
                <button className="modal-close" onClick={closePdf} data-i18n="close">Cerrar</button>
                <iframe className="modal-iframe" id="pdfFrame" src={pdfViewerSrc} referrerPolicy="no-referrer"></iframe>
              </div>
            </div>
          ) : null}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
