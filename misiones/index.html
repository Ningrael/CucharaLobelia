<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Misiones â€“ @cucharalobelia</title>
  <!-- React 18 + Babel (sin build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{margin:0;height:100%;background:#3b2b20}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useRef, useState, useEffect } = React;

    // ===== Config & datos =====
    const IMAGE_BG = ""; 

    const POOLS = [
      { title: "POOL 1 â€” HOLD OBJECTIVE", items: [
        "Domination", "Capture & Control", "Breakthrough", "Stake a Claim",
      ]},
      { title: "POOL 2 â€” KILL THE ENEMY", items: [
        "To the Death!", "Lords of Battle", "Assassination", "Contest of Champions",
      ]},
      { title: "POOL 3 â€” MAELSTROM OF BATTLE", items: [
        "Hold Ground", "Heirloom of Ages Past", "Sites of Power", "Command the Battlefield",
      ]},
      { title: "POOL 4 â€” OBJECT", items: [
        "Destroy the Supplies", "Retrieval", "Seize the Prizes", "Treasure Hoard",
      ]},
      { title: "POOL 5 â€” MANOEUVRING", items: [
        "Reconnoitre", "Storm the Camp", "Divide & Conquer", "Escort the Wounded",
      ]},
      { title: "POOL 6 â€” UNIQUE", items: [
        "Fog of War", "Clash by Moonlight", "Lead from the Front", "Convergence",
      ]},
    ];

    // ===== PequeÃ±o "test" de estructura para evitar errores de mapeo =====
    (()=>{
      if (!Array.isArray(POOLS)) {
        console.error("POOLS no es un array.");
      } else {
        const bad = POOLS.filter(p => !p || !Array.isArray(p.items) || p.items.length!==4);
        if (bad.length) console.warn("AlgÃºn pool no tiene exactamente 4 items: ", bad);
      }
    })();

    const PAGES_BY_MISSION = {
      "Domination": "https://drive.google.com/file/d/1h3OUvVS59GOClhn5Qcj-FscDpZobNo6h/preview",
      ...Object.fromEntries(
        POOLS.flatMap(p => (p.items||[]).filter(n=>n!=="Domination").map(n => [n, "1"]))
      )
    };

    const slug = (s) => String(s||"").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");

    function openPlaceholder(missionName) {
      const html = `<!doctype html><meta charset="utf-8"><title>${missionName}</title>
      <style>html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Inter}
      .wrap{display:flex;align-items:center;justify-content:center;height:100%;background:#0c0b09;color:#f3e9d2}
      .card{padding:36px 28px;border:1px solid #8a6a2f;border-radius:18px;background:linear-gradient(180deg,#1b1a17,#12110f);box-shadow:0 12px 40px rgba(0,0,0,.55);text-align:center}
      h1{margin:0 0 10px;font-size:22px;letter-spacing:.2px}
      p{margin:0;opacity:.9}</style>
      <div class="wrap"><div class="card"><h1>${missionName}</h1><p>En construcciÃ³n</p></div></div>`;
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function App(){
      const missions = useMemo(()=> POOLS.flatMap(p=> (p.items||[])), []);
      const [selected, setSelected] = useState("");
      const [toast, setToast] = useState("");
      const toastTimer = useRef(null);
      const refs = useRef({});

      const [roundsInput, setRoundsInput] = useState("3");
      const [badges, setBadges] = useState({});

      const screenRef = useRef(null);
      const bannerRef = useRef(null);
      const controlsRef = useRef(null);
      const gridRef = useRef(null);

      const recalcSizes = () => {
        const screen = screenRef.current; if (!screen) return;
        const bannerH = (bannerRef.current&&bannerRef.current.getBoundingClientRect().height) || 0;
        const controlsH = (controlsRef.current&&controlsRef.current.getBoundingClientRect().height) || 0;
        const availH = screen.clientHeight - bannerH - controlsH;
        const availW = screen.clientWidth;

        const gap = 8;
        const cols = 2, rows = 3;
        const cellW = (availW - gap*(cols+1)) / cols;
        const cellH = (availH - gap*(rows+1)) / rows;
        const tile = Math.floor(Math.min(cellW, cellH));

        const pad = 8;
        const innerW = tile - pad*2;
        const innerH = tile - pad*2;
        const btnGap = gap;
        const subCols = 2, subRows = 2;
        const btnW = (innerW - btnGap*(subCols-1)) / subCols;
        const btnH = (innerH - btnGap*(subRows-1)) / subRows;

        const rootStyle = gridRef.current && gridRef.current.style; if (!rootStyle) return;
        rootStyle.setProperty("--tile", `${tile}px`);
        rootStyle.setProperty("--btnW", `${btnW}px`);
        rootStyle.setProperty("--btnH", `${btnH}px`);
        rootStyle.setProperty("--gap", `${gap}px`);
      };

      useEffect(()=>{
        recalcSizes();
        const onR = () => recalcSizes();
        window.addEventListener('resize', onR);
        return ()=> window.removeEventListener('resize', onR);
      },[]);

      const showToast = (msg) => { setToast(msg); if (toastTimer.current) clearTimeout(toastTimer.current); toastTimer.current = setTimeout(()=> setToast(""), 1600); };
      const choose = (name) => setSelected(name);
      const pickRandom = () => { if (!missions.length) return; setBadges({}); const name = missions[Math.floor(Math.random()*missions.length)]; choose(name); showToast(`ðŸŽ² ${name}`); };
      const handleClickMission = (name) => { choose(name); const url = PAGES_BY_MISSION[name]; if (url && url !== "1") window.open(url, "_blank"); else openPlaceholder(name); };

      const genTournament = () => {
        const raw = roundsInput === "" ? "3" : roundsInput; let n = parseInt(raw, 10); if (Number.isNaN(n)) n = 3; const count = Math.max(1, Math.min(6, n));
        const idxs = Array.from({length: POOLS.length}, (_,i)=>i); for (let i=idxs.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [idxs[i],idxs[j]]=[idxs[j],idxs[i]]; }
        const chosen = idxs.slice(0,count); const newBadges={}; const seq=[]; chosen.forEach((pi,k)=>{ const pool=POOLS[pi]; const m=(pool.items||[])[Math.floor(Math.random()*pool.items.length)]; newBadges[m]=k+1; seq.push({round:k+1,mission:m});});
        setBadges(newBadges); const last=seq[seq.length-1]; if(last) choose(last.mission); seq.forEach((s,k)=> setTimeout(()=> showToast(`ðŸ† R${s.round}: ${s.mission}`), 500+k*900));
      };

      const incRounds = () => { let n = parseInt(roundsInput || "3", 10); if (Number.isNaN(n)) n = 3; if (n < 6) setRoundsInput(String(n+1)); };
      const decRounds = () => { let n = parseInt(roundsInput || "3", 10); if (Number.isNaN(n)) n = 3; if (n > 1) setRoundsInput(String(n-1)); };

      const bgImage = IMAGE_BG ? `linear-gradient(rgba(12,11,9,.25),rgba(12,11,9,.55)), url(${IMAGE_BG})` : "linear-gradient(160deg,#302419,#1e1712)";

      return (
        <div className="stage" style={{minHeight:"100svh",display:"flex",alignItems:"center",justifyContent:"center",background:bgImage,backgroundSize:"cover",backgroundPosition:"center"}}>
          <style>{`
            :root{
              --wood-dark:#3A2A1E; --wood-mid:#6b4a2f; --wood-light:#996a3a;
              --cream:#EFE5CF; --cream-2:#f6ecd6; --ink:#2a241b; --ink-soft:#5b4a39;
              --gold:#CFA15B; --gold-2:#ead39a; --shadow:0 20px 60px rgba(0,0,0,.35);
              --pill:9999px; --gap:8px;
            }
            *{box-sizing:border-box}
            .phone{aspect-ratio:9/16; width:min(92vw,430px); max-height:min(94vh,860px); border-radius:22px; padding:10px; box-shadow:var(--shadow);
              background:linear-gradient(180deg,var(--wood-dark),#2b1e14); border:1px solid rgba(0,0,0,.45); position:relative}
            .screen{position:absolute; inset:12px; border-radius:18px; overflow:hidden; display:flex; flex-direction:column;
              background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.06)}

            .banner{padding:6px 10px; border-bottom:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.18); display:flex; align-items:center}
            .brand{font-family:Georgia,serif; font-weight:900; color:#f4e9d2; font-size:16px; letter-spacing:.3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

            .controls{padding:6px 10px; display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:nowrap;
              border-bottom:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.12)}
            .btn-gold{background:linear-gradient(180deg,var(--gold-2),var(--gold)); border:1px solid #b79045; border-radius:var(--pill); color:var(--ink); padding:6px 10px; font-weight:800}
            .stack{display:flex; align-items:center; gap:6px; white-space:nowrap}
            .btn-circle{width:22px;height:22px;border-radius:var(--pill);display:inline-flex;align-items:center;justify-content:center;border:1px solid #b79045;background:linear-gradient(180deg,var(--gold-2),var(--gold));color:var(--ink);font-weight:900}
            .rounds-input{appearance:none;-moz-appearance:textfield;width:40px;padding:4px 6px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.25);color:#f4e9d2;font-weight:800;text-align:center}
            .btn-secondary{border-radius:var(--pill); border:1px solid rgba(234,211,154,.5); background:rgba(12,11,9,.45); color:#f4e9d2; padding:6px 10px; font-weight:800}
            .controls label{color:#f4e9d2; font-weight:900; opacity:.95}

            .content{flex:1; overflow:hidden}
            .pools, .pools-grid{height:100%}
            .pools{padding:var(--gap)}
            .pools-grid{display:grid; grid-template-columns:repeat(2, var(--tile)); grid-template-rows:repeat(3, var(--tile)); gap:var(--gap); justify-content:center}

            .pool-card{width:var(--tile); height:var(--tile); background:linear-gradient(180deg,var(--cream),var(--cream-2)); border:1px solid rgba(0,0,0,.12); border-radius:12px; padding:8px; box-shadow:0 4px 12px rgba(0,0,0,.12); display:flex; flex-direction:column}

            .missions{list-style:none; padding:0; margin:0; flex:1; display:grid; grid-template-columns:repeat(2, 1fr); grid-template-rows:repeat(2, 1fr); gap:var(--gap); align-items:stretch; justify-items:stretch}
            .item{width:100%; height:100%; border:1px solid rgba(0,0,0,.10); border-radius:12px; background:#fff8e9; display:flex; align-items:center; justify-content:center; padding:4px; text-align:center; box-shadow:inset 0 -1px 0 rgba(0,0,0,.04)}
            .item .label{font-weight:700; font-size:11px; color:var(--ink); max-width:100%; text-align:center; line-height:1.2; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
            .item:hover{filter:brightness(1.02)}
            .item:active{transform:translateY(1px)}
            .item.selected{outline:2px solid #caa24f; outline-offset:1px; box-shadow:0 0 10px rgba(202,162,79,.28)}
            .badge{position:absolute; right:6px; top:6px; padding:2px 6px; border-radius:999px; background:rgba(12,11,9,.85); border:1px solid rgba(234,211,154,.6); color:#f2e6c6; font-size:10px; font-weight:800}

            .toast{position:fixed; top:10px; left:50%; transform:translateX(-50%) translateY(-8px); opacity:0; pointer-events:none; background:rgba(12,11,9,.88); color:#f4e9d2; border:1px solid rgba(234,211,154,.5); padding:8px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.45); font-weight:800}
            .toast.show{opacity:1; transform:translateX(-50%) translateY(0); transition:opacity .18s ease, transform .18s ease}
          `}</style>

          <div className="phone">
            <div className="screen" ref={screenRef}>
              <div className="banner" ref={bannerRef}>
                <div className="brand">@cucharalobelia Misiones</div>
              </div>

              <div className={"toast" + (toast?" show":"")}>{toast}</div>

              <div className="controls" ref={controlsRef}>
                <button onClick={pickRandom} className="btn-gold" title="Elegir una misiÃ³n al azar">Elegir Random</button>
                <div className="stack">
                  <label>Rondas</label>
                  <button className="btn-circle" onClick={decRounds}>-</button>
                  <input className="rounds-input" type="text" inputMode="numeric" aria-label="NÃºmero de rondas" placeholder="3" value={roundsInput}
                    onChange={(e)=>{ const v=e.target.value.trim(); if (v===""){setRoundsInput("");return;} if (/^[1-6]$/.test(v)){setRoundsInput(v);} }}
                    onBlur={()=>{ if (roundsInput === "") setRoundsInput("3"); }} />
                  <button className="btn-circle" onClick={incRounds}>+</button>
                </div>
                <button onClick={genTournament} className="btn-secondary" title="Generar rondas de torneo">Generar</button>
              </div>

              <div className="content">
                <div className="pools">
                  <div className="pools-grid" ref={gridRef}>
                    {Array.isArray(POOLS) && POOLS.map((pool, pi)=> (
                      <section key={pi} className="pool-card">
                        <ul className="missions">
                          {(pool.items||[]).map((name)=> {
                            const isSel = selected === name;
                            return (
                              <li key={name} style={{position:'relative'}}>
                                <button
                                  ref={el=>{ if(el) refs.current[name]=el; }}
                                  id={slug(name)}
                                  onClick={()=> handleClickMission(name)}
                                  className={"item" + (isSel?" selected":"")}>
                                  <span className="label">{name}</span>
                                  {badges[name] ? <span className="badge">R{badges[name]}</span> : null}
                                </button>
                              </li>
                            );
                          })}
                        </ul>
                      </section>
                    ))}
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
